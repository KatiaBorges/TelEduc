-----------------------------------------------------------------------
Campinas, 01 de Outubro de 2004
Manual de instalação e configuração do Apache, MySQL, PHP e TelEduc
versão: TelEduc-3.3.2
-----------------------------------------------------------------------

-----------------------------------------------------------------------
Observações importantes:
 - Leia todo o passo antes de realizá-lo para evitar erros.
 - É importante notar que usamos exemplos para ilustrar comandos.
 - Muitas vezes pode ser que o caminho dos comandos pode ser diferente
   para cada caso. Isso dependerá da instalação que cada usuário fizer
   para cada pacote.
 - A versão 4.3.8 do PHP apresenta bugs de compatibilidade com o TelEduc. Instale uma versão superior ou utilize
   uma versão anterior a ela (4.3.4 por exemplo). Neste exemplo iremos utilizar a versão 5.0.1.
----------------------------------------------------------------------- 

INSTALAÇÃO PASSO-A-PASSO TELEDUC
================================

INSTALAÇÃO E CONFIGURAÇÃO DO MySQL
INSTALAÇÃO E CONFIGURAÇÃO DO Apache E PHP
INSTALAÇÃO E CONFIGURAÇÃO DO TelEduc

APÊNDICE A
 Arquivo de configuração do Apache (httpd.conf ou .htaccess)
 Arquivo crontab ('/etc/crontab')

APÊNDICE B
 Links


Neste manual nós acreditamos que você já tenha um Linux instalado e funcionando. Tenha certeza de que seu copilador C esteja funcionando.

Você precisará dos seguintes softwares:

    * Última versão binária do MySQL (Ex: MySQL 4.1.3), disponível em www.mysql.com
    * Última versão do PHP (Ex: PHP 5.0.1), disponível em www.php.net
    * Última versão do Apache 2 (Ex: Apache 2.0.50), em www.Apache.org


Você também precisará da seguinte biblioteca:

    * A última versão da biblioteca libxml2 (Ex. libxml2 2.6.11)
    * A última versão da biblioteca zlib (Ex. zlib 1.0.9)

Copie todos para seu /tmp e siga os passos:

$ cd /tmp

$ tar -xzvf mysql-standard-4.1.x.tar.gz

$ tar -xzvf php-5.0.1.tar.gz

$ tar -xzvf httpd-2.0.50.tar.gz

$ tar -xzvf libxml2-2.6.11.tar.gz

$ tar -xzvf zlib-1.2.1.tar.gz

* Faça todos os passos como root*

Instalando as bibliotecas

Primeiro, cheque se você precisa instalar libxml2 ou zlib. PHP 5.0 requer libxml2 2.6.0 (ou superior) e zlib 1.0.9 (ou superior). Se você não tem eles instalados, continue lendo, senão pule esta parte e vá para a instalação do MySQL.

Para começar, compile e instale libxml2 XML primeiro, o qual vai disponibilizar uma nova API XML para o PHP 5.0:

$ cd /tmp/libxml2-2.6.11
$ ./configure
$ make && make install

No final, libxml2 será instalada em /usr/local/. Se você quiser utilziar em outro lugar use --prefix option para instalar em outro lugar.

Agora, compile a zlib:

$ cd /tmp/zlib-1.2.1
$ ./configure
$ make && make install

No final, zlib será instalada em  /usr/local/. Se você quiser utilziar em outro lugar use --prefix option para instalar em outro lugar..

* Tanto zlib quanto libxml2 não serão utilizadas pelo TelEduc, mas o PHP 5.0 necessita destas bibliotecas. Além de mais, se outra aplicação utilziar essas bibliotecas, não será necessário você recopilar o PHP.


Instalando MySQL


PRIMEIRO MODO DE INSTALAÇÃO

# tar -xvzf mysql(...).tar.gz

Entre no diretório e digite:

# ./configure --prefix=/usr/local/mysql
# make
# make install
ou
# checkinstall
(se você tiver com o checkinstall instalado)

Depois de instalado, vá para pasta /usr/local/mysql/bin e digite:

# ./mysql_install_db --user=root
# ./safe_mysqld --user=root &
# ./mysqladmin -u root password novopassword




SEGUNDO MODO DE INSTALAÇÃO(Caso você tenha algum problema com o modo acima)

Primeiro:

   1. Descompacte o MySQL e mova a pasta para /usr/local/mysql.

$ mv /tmp/mysql-standard-4.1.x /usr/local/mysql 

   2. Crie um usuário e um grupo para o MySQL.

$ groupadd mysql

$ useradd -g mysql mysql

   3. Inicialize o MySQL grant tables utilizando mysql_install_db script.

$ /usr/local/mysql/scripts/mysql_install_db --user=mysql [/output]

   4. De ao MySQL user direitos sobre o diretório do MySQL.

$ chown -R root  /usr/local/mysql

$ chgrp -R mysql /usr/local/mysql

$ chown -R mysql /usr/local/mysql/data

   5. Inicialize o MySQL server.

$ /usr/local/mysql/support-files/mysql.server start

Cheque para ter certeza que MySQL server socket foi criado em /tmp/ com um nome como mysql.socki

Instalando Apache


$ cd /tmp/httpd-2.0.50

$ ./configure --prefix=/usr/local/apache2 --enable-so 
$ make && make install

Isto deve configurar, compilar, e instalar o servidor em /usr/local/apache2.



Instalando PHP

Com o MySQL e Apache installados, o passo final é copilar e instalar o PHP. O passo mais importante deste processo envolve o script de configuração do PHP. ELe contém várias opções.

Nós iremos utiliziar as seguintes opções:

    * --prefix Seta o caminho de instalacão do PHP 5.0.
    * --with-apxs2 mostra para o PHP onde encontrar Apache 2.0.
    * --with-libxml-dir and --with-zlib-dir mostra para o PHP onde encontram-se estas bibliotecas. Se a instalação das bibliotecas foi feita por padrão, não será necessári dizer onde está o diretório, apenas dizer que você quer que instalae com o suporte.
    * --with-mysql diz para o PHP ser instalado com suporte a MySQL.


$ ./configure --help mostra todas as opções.

As opções que geralmente utilizamos são:
$./configure --with-mysql --prefix=/usr/local/php5/ --with-apxs2=/usr/local/apache2/bin/apxs --with-zlib	

Depois de ter feito a configuração, você pode compilar e instalar PHP.

$ make
$ make install

Configurando e testando Apache com PHP

** Existe dentro da pasta instalação do TelEduc um php.ini do PHP 5.0.1 configurado e um httpd.conf do Apache 2.0.50 configurado.

Agora você precisa configurar seu httpd.conf(arquivo de configuração do APACHE), /usr/local/apache2/conf/httpd.conf, e adicionar as seguinte linha:

         ServerName nome.da.maquina

         AddType application/x-httpd-php .php

         AddHandler cgi-script .cgi

         DirectoryIndex index.html index.htm index.php


      , onde "nome.da.maquina" é o hostname do servidor.

      Adicione também as seguintes linhas para impedir o acesso aos arquivos
      '.inc' e '.conf'. Acrescente este último apenas se as aplicações do seu
      servidor Web não utilizarem essa extensão:

         <Files ~ "\.inc$">
             Order allow,deny
             Deny from all
             Satisfy All
         </Files>

         <Files ~ "\.conf$">
             Order allow,deny
             Deny from all
             Satisfy All
         </Files>

         <Files ~ "\.auth$">
             Order allow,deny
             Deny from all
             Satisfy All
         </Files>


	 Altere a seguinte linha, colocando pt-BR no começo, para se evitar problemas com acentos:

         LanguagePriority pt-BR en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt ru sv zh-CN zh-TW


Dentro do diretório que você descompactou o PHP, existe um arquivo chamado "php.ini-dist". Copie este arquivo para o diretório "/usr/local/php5/lib" com o nomede "php.ini".

*O diretório é /usr/local/php5/lib pois foi onde instalamos nosso PHP

Altere neste php.ini a linha register_globals de Off para On



Salve o arquivo e inicie o Apache:

$ /usr/local/apache2/bin/apachectl start

Você pode testar se sua instalacão está funcionando criando um script nesta pasta "/usr/local/apache2/htdocs/".

Crie um script com o nome de teste.php, e escreva as seguintes linhas nele:

<?php

phpinfo();

?>

Salve o arquivo e conecte pelo browser no seguinte endereço http://localhost/test.php.

Você entrará numa página com informações do seu PHP e apache:


INSTALAÇAO E CONFIGURAÇAO DO TelEduc
---------------------------------------

Como ROOT, adicione um usuário e altere sua senha. Em nosso exemplo criamos o usuário "teleduc":

      # /usr/sbin/useradd teleduc
      # /usr/bin/passwd teleduc

      Como ROOT, adicione as seguintes linhas para permitir a execução do script
      perl do Batepapo ao arquivo "httpd.conf", localizado em nosso exemplo na
      pasta "/usr/local/apache/conf":

      <Directory /home/teleduc/public_html>
        AllowOverride None
        Options FollowSymLinks
      </Directory>

      <Directory /home/teleduc/public_html/cursos/aplic/batepapo>
        AllowOverride None
        Options ExecCGI FollowSymLinks
      </Directory>

      OBS.: Lembre-se de alterar o caminho caso o usuário criado seja outro que
            não o do nosso exemplo.

      Como ROOT, reinicie o daemon do servidor Apache. Em nosso exemplo ele foi
      instalado na pasta "/usr/local/apache":

      # /usr/local/apache/bin/apachectl restart

      Alterne para a conta do usuário criada:

      # su teleduc

      Entre no diretório home deste usuário e crie uma pasta chamada "public_html":

      $ cd ~/
      $ mkdir public_html

      Copie o arquivo do TelEduc para essa pasta, "public_html", e em seguida
      o descompacte:

      $ cp teleduc-v3.3.2.tar.gz /home/teleduc/public_html
      $ tar -xzvf teleduc-v3.3.2.tar.gz

      Entre na pasta "instalacao" e execute o script "configure". Ele ajustará a
      permissão dos diretórios. Alguns diretórios importantes
      "/home/teleduc/public_html" e "/home/teleduc/public_html/cursos" ficarão
      provisóriamente com modo 777, para serem usados durante a criação dos
      diretórios de arquivos de curso, e sendo modificados para 755 no término da
      etapa 4.09.

      $ ./configure

      Via browser, entre na página de instalação do TelEduc e preencha os dados
      requisitados (O Apache e o MySQL devem estar em execução)

      http://nome.da.maquina/~teleduc/instalacao/

      , onde "nome.da.maquina" é o hostname do servidor.


      Após preencher os dados execute o script "configure_end", no diretório
      "instalacao", que ajustará a permissão dos diretórios. Todos os diretórios
      que antes estavam em 777 serão trocados para 755:

      $ ./configure_end


      Edite o arquivo "sala_meio.cgi" ("cursos/aplic/batepapo/") verificando se
      a primeira linha aponta corretamenta para a localização se seu shell:

        #!/bin/bash

      OBS.: 1) A linha acima deve ser a primeira do arquivo "sala_meio.cgi";
            2) Caso não saiba onde está seu shell execute o comando:
                 $ chsh -l

      Altere as permissões do arquivo 'sala_meio.cgi' (localizado na pasta
      'cursos/aplic/batepapo/') para que possa ser executado:

        $ chmod +x sala_meio.cgi

      A partir da versão 3.1.5 foi incorporado um recurso de notificar os usuários
      sobre novidades no ambiente. Essa notificação é feita através do e-mail
      cadastrado no curso.

      A configuração desse recurso encontra-se na ferramenta 'Configurar',
      'Notificar novidades'.

      Para realizar a notificação de novidades um script deve ser agendado no arquivo
      referente à conta do usuário utilizada para executar as tarefas agendadas:
      'root' (localizado por padrão em '/var/spool/cron/') para o script a ser
      executado pelo usuário 'root'.

      Como ROOT, edite o arquivo 'root' (localizado por padrão em '/var/spool/cron/')
      adicionado as seguintes linhas:

         0 17 * * * /usr/bin/lynx -dump http://nome.da.maquina.dom/~teleduc/scripts/notificar.php?notificar_email=1
         0 9 * * * /usr/bin/lynx -dump http://nome.da.maquina.dom/~teleduc/scripts/notificar.php?notificar_email=2
         0 18 * * * /usr/bin/lynx -dump http://nome.da.maquina.dom/~teleduc/scripts/notificar.php?notificar_email=2

         , onde "nome.da.maquina" corresponde ao hostname ou endereço ip do servidor
                "notificar_email" controla a opção de notificação:
                                  1 - Resumo diário
                                  2 - Resumo parcial (2x)

         No exemplo acima os usuários que optarem pelo resumo diário, o receberã£o às
         17h00. Os que optarem pelos resumos parciais receberão às 09h00 e às
         18h00. Altere os valores para os horários de preferência.

         OBS.: a) O arquivo '/var/spool/cron/root' deve conter uma linha vazia no final dele;
               b) O script não pode ser executado remotamente, i.e., se alguém que não
                  esteja no servidor tentar executar o script através do endereço
                  http://nome.da.maquina.dom/~teleduc/scripts/notificar.php?notificar_email=2
                  não obterá sucesso.

      Como ROOT, reinicie o daemon do 'cron':

        # /etc/init.d/crond restart

      Como ROOT, liste as tarefas do crontab para certificar-se de que as alterações
      terão efeito:

        # /usr/bin/crontab -l

      Se as linhas adicionadas estiverem presentes, o 'cron' as executará nos horários
      prescritos. Do contrário, procure pelo arquivo 'crontab' (localizado por padrão em
      '/etc/') e adicione as linhas mencionadas no passo 4.12.

      Se não houve problemas, o TelEduc está agora instalado e funcionando
      corretamente, podendo ser acessado a partir de:

      http://nome.da.maquina/~teleduc/



APÊNDICE A
-------------

     Arquivo de configuração do Apache (httpd.conf ou .htaccess):
     OBS.: Somente algumas diretivas e opções estão listadas. Consulte a 
           documentação que acompanha o servidor Apache ou a que se encontra
           disponíuvel em sua página de projeto (Veja "APÊNDICE B").
     
      ----------------------------------------------------------------------------------
       Diretiva: Options
       Resumo  : A diretiva Options controla quais propriedades do servidor
                 estão disponíveis em um diretório particular.
       Valores :
                 ExecCGI        : Permite a execução de CGI's.
                 FollowSymLinks : O servidor irá percorrer os links simbólicos
                                  nessa pasta.
                 Indexes        : permite listar o conteúdo de uma pasta através 
                                  da url http://nome.da.maquina/nome_da_pasta/
                 MultiViews     : pesquisa arquivos com outras extensões caso não
                                  localize o arquivo especificado. Ex.: se não
                                  encontrar o arquivo 'manual.txt' procura por
                                  'manual.*'
                 Include        : ativa o suporte a SSI (Server Side Includes),
                                  diretivas que são "resolvidas" durante a montagem
                                  da página permitindo a geração de contexto dinâmico
                                  sem a necessidade de um programa CGI ou ferramenta
                                  de geração de conteúdo dinâmico.
       Sintaxe : O sinal de '+' é opcional. Para desabilitar uma propriedade
                 adicione o sinal de '-':
                   Options Indexes MultiViews Include FollowSymLinks
                   Options +Indexes +MultiViews +Include +FollowSymLinks
                   Options -Indexes -MultiViews -Include -FollowSymLinks
       Exemplo :
                 <Directory /usr/local/apache/htdocs>
                     Options FollowSymLinks -Indexes MultiViews
                     AllowOverride None
                     Order allow,deny
                     Allow from all
                 </Directory>
      ----------------------------------------------------------------------------------

     Arquivo crontab ('/var/spool/cron/NOME_DO_USUARIO' ou '/etc/crontab'):
     OBS.: O arquivo '/var/spool/cron/NOME_DO_USUARIO' ou '/etc/crontab' deve conter
           uma linha vazia no final dele;

     O arquivo 'NOME_DO_USUARIO' ou 'crontab' possui seis colunas. São elas:

       - primeira coluna: minutos       (0-59)
       - segunda  coluna: horas         (0-23)
       - terceira coluna: dia do mês    (1-31)
       - quarta   coluna: mês do ano    (1-12)
       - quinta   coluna: dia da semana (0-6), onde 0 = Domingo
       - sexta    coluna: comando a ser executado

       O asterisco (*) é um caractere curinga ou seja ele pode assumir qualquer valor.

       Exemplos:
          a)  30 12 * * * /bin/bash backup_diario.sh
              Executa o script 'backup_diario.sh' às 12 horas e 30 minutos, todos os dias,
              todos os meses, todos os anos.

          b)  0 0 1 * * /bin/bash backup_mensal.sh
              Executa o script 'backup_mensal.sh' todo dia primeiro de cada mês às zero hora,
              todos os meses, todos os anos.



APÊNDICE B
-------------

Links:

       TelEduc:
       http://teleduc.nied.unicamp.br

       Apache HTTP Server Project:
       http://httpd.apache.org

       PHP Hypertext Preprocessor:
       http://www.php.net

       Lynx:
       http://lynx.isc.org

       MySQL:
       http://www.mysql.com

       Sendmail Home Page:
       http://www.sendmail.org

       RPMFind
       http://www.rpmfind.net
